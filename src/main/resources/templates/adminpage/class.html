<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<!--Head-->
<div th:replace="~{fragments/head-admin}"></div>
<!--Head-->

<body>
<div class="layer"></div>
<!-- ! Body -->
<a class="skip-link sr-only" href="#skip-target">Skip to content</a>
<div class="page-flex">

    <!-- ! Sidebar -->
    <div th:replace="~{fragments/sidebar-admin}"></div>
    <!-- ! Sidebar -->

    <div class="main-wrapper">

        <!-- ! Main nav -->
        <div th:replace="~{fragments/header-admin}"></div>
        <!-- ! Main nav -->

        <!-- ! Main -->
        <div class="main">
            <div class="container">

                <!--   Alert   -->
                <div th:if="${message != null}">
                    <div class="row px-sm-0 px-lg-5">
                        <div th:class="|alert alert-${alert} alert-dismissible fade show|" role="alert">
                            <span th:text="${message}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    </div>
                </div>
                <!--   Alert   -->

                <h2 class="main-title text-center text-uppercase">Quản lý khoa và lớp</h2>
                <div class="row d-flex justify-content-between px-sm-0 px-lg-5">
                    <div class="col-4">
                        <a type="button" class="btn btn-primary" th:href="@{/admin/faculty-and-class/edit-faculty}">
                            <i class="fa-solid fa-plus"></i> Tạo Khoa
                        </a>
                    </div>
                    <form method="get" th:action="@{/admin/faculty-and-class}" class="col-8">
                        <div class="input-group">
                            <select class="form-select" name="facultyCode">
                                <option value="" selected>Tất cả</option>
                                <th:block th:each="f: ${facultySelect}">
                                    <option th:value="${f.code}" th:text="${f.name}"></option>
                                </th:block>
                            </select>
                            <input type="text" name="keyword" value="" class="form-control" placeholder="Tìm" />
                            <button type="submit" class="btn btn-primary"><i class="fas fa-search"></i></button>
                        </div>
                    </form>
                </div>
                <div class="list-group px-sm-0 px-lg-5">
                    <th:block th:each="f: ${faculties}">
                        <div class="list-group-item d-flex justify-content-between align-items-center mt-3">
                            <div class="d-flex align-items-center">
                                <h5 class="d-inline-block fixed-w-200"><p th:text="${f.name}" th:remove="tag"></p><span th:text="${f.code}" class="badge bg-primary ms-3"></span></h5>
                                <button class="btn btn-sm btn-outline-primary btn_seemore ms-4">
                                    Ẩn <i class="fa-solid fa-chevron-up"></i>
                                </button>
                            </div>
                            <div>
                                <form class="delete_faculty_form" th:data-faculty-id="${f.id}" th:action="@{/admin/faculty-and-class/delete-faculty/{id}(id=${f.id})}" method="post">
                                    <a class="btn btn-sm btn-primary" th:href="@{/admin/faculty-and-class/edit-class?facultyCode={facultyCode}(facultyCode=${f.code})}">
                                        <i class="fa-solid fa-plus"></i> Tạo Lớp
                                    </a>
                                    <a class="btn btn-sm btn-success" th:href="@{/admin/faculty-and-class/edit-faculty/{id}(id=${f.id})}">
                                        <i class="fa-regular fa-pen-to-square"></i> Sửa
                                    </a>
                                    <button type="button" class="btn btn-sm btn-danger delete_faculty_btn">
                                        <i class="fa-regular fa-trash-can"></i> Xóa
                                    </button>
                                </form>
                            </div>
                        </div>
                        <div class="list-group">
                            <th:block th:each="class: ${f.classes}">
                                <div class="list-group-item d-flex justify-content-between pe-4">
                                    <div><p th:text="${class.name}" th:remove="tag"></p><span th:text="${class.code}" class="badge bg-primary ms-3"></span></div>
                                    <div>
                                        <form class="delete_class_form" th:data-class-id="${class.id}" th:action="@{/admin/faculty-and-class/delete-class/{id}(id=${class.id})}" method="post">
                                            <a class="btn btn-sm btn-outline-success" th:href="@{/admin/faculty-and-class/edit-class/{id}?facultyCode={facultyCode}(id=${class.id}, facultyCode=${f.code})}">
                                                <i class="fa-regular fa-pen-to-square"></i> Sửa
                                            </a>
                                            <button type="button" class="btn btn-sm btn-outline-danger delete_class_btn">
                                                <i class="fa-regular fa-trash-can"></i> Xóa
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </th:block>
                        </div>
                        <hr>
                    </th:block>
                </div>
            </div>

            <!-- ! Footer -->
            <div th:replace="~{fragments/footer-admin}"></div>
            <!-- ! Footer -->

            <!-- ! Modal -->
            <div th:replace="~{fragments/modal}"></div>
            <!-- ! Modal -->

        </div>
    </div>
</div>
<div th:replace="~{fragments/scripts}"></div>
<!-- Icons library -->
<script th:src="@{/adminpage/plugins/feather.min.js}"></script>
<!-- Custom scripts -->
<script th:src="@{/adminpage/js/script.js}"></script>
<script th:inline="javascript">
    function getParentElement(element, parent) {
        while (element.parentElement) {
            if (element.parentElement.matches(parent)) {
                return element.parentElement;
            }
            element = element.parentElement;
        }
    }

    $(".btn_seemore").each(function (index, element) {
        $(element).click(function (e) {
            e.preventDefault();
            if($(this).hasClass("hide"))
                $(this).html("Ẩn <i class='fa-solid fa-chevron-up'></i>").removeClass("hide");
            else
                $(this).html("Hiện <i class='fa-solid fa-chevron-down'></i>").addClass("hide");

            const list_items = getParentElement(element, ".list-group-item").nextElementSibling

            if($(list_items).hasClass("group-item_dp-none"))
                $(list_items).animate({maxHeight:220},200).removeClass("group-item_dp-none");
            else
                $(list_items).animate({maxHeight:0},200).addClass("group-item_dp-none");
        })
    })

    $(document).ready(function () {
        let c = $(".btn_seemore").length;
        let btn_seemore = $(".btn_seemore")
        for (let index = c-1; index > 1; index--) {
            btn_seemore[index].click()
        }

        $(".delete_class_btn").each(function (index, element) {
            $(element).on('click', function(e) {
                let classId = $(getParentElement(element, '.delete_class_form')).data('class-id')
                $('#delete_modal').data('class-id', classId)
                $('#delete_modal').data('delete-target', 'class')
                $('#delete_modal .modal-body span').text('Bạn có chắc muốn xóa Lớp này ?')
                $('#delete_modal').modal('show')
            })
        })

        $(".delete_faculty_btn").each(function (index, element) {
            $(element).on('click', function(e) {
                let facultyId = $(getParentElement(element, '.delete_faculty_form')).data('faculty-id')
                $('#delete_modal').data('faculty-id', facultyId)
                $('#delete_modal').data('delete-target', 'faculty')
                $('#delete_modal .modal-body span').text('Bạn có chắc muốn xóa Khoa này ?')
                $('#delete_modal').modal('show')
            })
        })

        $('#delete_confirm').click(function (e) {
            e.preventDefault();
            const delete_target = $('#delete_modal').data('delete-target')
            if (delete_target === 'class') {
                let classId = $('#delete_modal').data('class-id')
                $(".delete_class_form[data-class-id='"+classId+"']").submit()
            } else if (delete_target === 'faculty') {
                let facultyId = $('#delete_modal').data('faculty-id')
                $(".delete_faculty_form[data-faculty-id='"+facultyId+"']").submit()
            } else $('#delete_modal').modal('hide')
        })
    });

</script>
</body>
</html>